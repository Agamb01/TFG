%---------------------------------------------------------------------
%
%                          Capítulo 2
%
%---------------------------------------------------------------------

\chapter{Introducción al procesador}
\label{procesador}

\begin{FraseCelebre}
  \begin{Frase}
    "`La idea detrás de los computadores digitales puede explicarse diciendo que estas máquinas están destinadas a llevar a cabo cualquier operación que pueda ser realizada por un equipo humano."'
  \end{Frase}
  \begin{Fuente}
    Alan Turing
  \end{Fuente}
\end{FraseCelebre}

\begin{resumen}
En este capítulo se define con detalle lo que es un procesador y su importancia en el mundo de hoy en día. También se introduce la arquitectura ARM.
\end{resumen}

%%-----------------------------------------------------------------
\section{Procesador}
%%-----------------------------------------------------------------
\label{procesador:procesador}

El Diccionario de la Real Academia Española (DRAE) define el procesador como la "`Unidad Central de Proceso (CPU), formada por uno o dos chips"'. Figura \ref{fig:cpu}. 

\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.50\textwidth]{Imagenes/Procesador/CPU.eps}
	\caption{Procesador}
	\label{fig:cpu}
\end{figure}

La CPU es el circuito integrado encargado de acceder a las instrucciones de los programas informáticos y ejecutarlas. Para poder ejecutar un programa, el procesador debe realizar las siguientes tareas:

\begin{enumerate}
  \item Acceder a las instrucciones almacenadas en memoria.
  \item Analizar las instrucciones y establecer las señales de control internas.
  \item Ejecutar operaciones sobre datos.
  \item Almacenar los resultados en memoria.
\end{enumerate}

A continuación se definen los elementos fundamentales para constituir un procesador.

%%%%-----------------------------------------------------------------
\subsection{Arquitectura}
%-----------------------------------------------------------------
\label{procesador:arquitectura}

Un procesador está formado por una serie de módulos conectados entre sí, siendo la arquitectura del mismo la que define el diseño de los módulos que lo componen y de qué manera se conectan entre ellos.

La arquitectura del procesador diseñada por Von Neumann separa los componentes del procesador en módulos básicos. La CPU es el verdadero núcleo de los computadores, donde se realizan las funciones de computación y control. En la CPU se concentran todos los componentes, la memoria y los elementos de entrada/salida \cite{Hennessy1993}. % Arquitectura de Computadores: Un enfoque cuantitativo

Según el juego de instrucciones que sea capaz de ejecutar un procesador, su arquitectura puede clasificarse como:

\begin{enumerate}
  \item \textit{Reduced instruction set computer (RISC)}. Utiliza un repertorio de instrucciones reducido, con instrucciones de tamaño fijo y poca variedad en su formato.
	
	\item \textit{Complex instruction set computer (CISC)}. Utiliza un repertorio de instrucciones muy amplio, permite realizar operaciones complejas entre las que se encuentran las de realizar cálculos entre los datos en memoria y los datos en registro.
\end{enumerate}

%%-----------------------------------------------------------------
\subsection{Repertorio de instrucciones}
%-----------------------------------------------------------------
\label{procesador:instrucciones}

El repertorio de instrucciones define todas las operaciones que el procesador es capaz de entender y ejecutar. Este juego de instrucciones incluye las operaciones aritmético-lógicas que pueden aplicarse a los datos, las operaciones de control sobre el flujo del programa, las instrucciones de lectura y escritura en memoria, así como todas las instrucciones propias que se hayan diseñado para el procesador.


%-----------------------------------------------------------------
\subsection{Memoria}
%-----------------------------------------------------------------
\label{procesador:memoria}

Los procesadores tienen una serie de registros donde se almacenan temporalmente los valores con los que está trabajando.
El conjunto de estos registros se conoce como "`banco de registros"'. Los registros de propósito general son muy limitados, por lo que el procesador necesita disponer de apoyo externo donde alojar la información, para ello tiene acceso a una memoria externa.

El modo de acceso a la memoria externa divide las arquitecturas en dos tipos, conocidas con los nombres de Von Neumann y Harvard. La arquitectura Von Neumann utiliza una única memoria para almacenar tanto los datos como las instrucciones. La arquitectura Harvard, sin embargo, separa la memoria de datos de la memoria de instrucciones. Figura \ref{fig:vonneumann_harvard}.

\begin{figure}[htbp]
  \centering
  \subfloat{\includegraphics[width=0.45\textwidth]{Imagenes/Procesador/VonNeumann.eps}} 
	  \hspace{5mm}
  \subfloat{\includegraphics[width=0.45\textwidth]{Imagenes/Procesador/Harvard.eps}}
  \caption{Arquitectura Von Neumann y Arquitectura Harvard} \label{fig:vonneumann_harvard}
\end{figure}


%-----------------------------------------------------------------
\subsection{Segmentación}
%-----------------------------------------------------------------
\label{procesador:segmentacion}

La segmentación consiste en dividir el procesador en etapas, de modo que en cada una de ellas se ejecute una parte de la instrucción. Al dividir las instrucciones se consigue que cada etapa procese de forma independiente una parte de las mismas. 

Las instrucciones van avanzando de etapa en etapa hasta que se terminen de procesar. De este modo se pueden tener en el procesador varias instrucciones ejecutándose de forma simultanea en distintas etapas, lo que resulta en un aumento significativo del rendimiento del procesador.

\begin{table}[htbp]
	\centering
	\resizebox{\textwidth}{!} {
		\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|}
		  \hline
			 & \multicolumn{9}{|c|}{Ciclo de reloj}                   \\ \hline
			Número de instrucción & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 \\ \hline
			i     & IF & ID & EX & MEM & WB & & & &                   \\ \hline
			i + 1 & & IF & ID & EX & MEM & WB & & & 									\\ \hline
			i + 2 & & & IF & ID & EX & MEM & WB & &                   \\ \hline
			i + 3 & & & & IF & ID & EX & MEM & WB &                   \\ \hline
			i + 4 & & & & & IF & ID & EX & MEM & WB                   \\ \hline
		\end{tabular}
	}
	\caption{Segmentacion simple de 5 etapas}
	\label{tab:segmentacion}
\end{table}

En la tabla \ref{tab:segmentacion} podemos ver cómo se procesan una serie de instrucciones en 5 etapas (IF, ID, EX, MEM, WB). Se observa cómo cada instrucción va ocupando una única etapa en cada ciclo de reloj, cómo cambian de una a otra al ser procesadas, permitiendo la ejecución de  la siguiente instrucción.

%-----------------------------------------------------------------
\subsubsection{Reducción de ciclos por segmentación}
%-----------------------------------------------------------------
\label{procesador:segmentacion:reduccion}

La segmentación proporciona la ventaja de poder lanzar una instrucción por cada ciclo de reloj. Característica que aumenta el rendimiento del procesador al obtener un menor número total de ciclos por instrucción para un mismo programa. Para conocer los ciclos por instrucción que necesita un programa se utiliza la formula: % \ref{eq:cpi}. 

\begin{equation}
		\textrm{Ciclos por instrucción (CPI)} = \frac{\textrm{Número de ciclos total}}{\textrm{Número de instrucciones}}
  \label{eq:cpi}
\end{equation}

A modo de ejemplo, veamos que sucede al ejecutar un programa de 3 instrucciones sobre un procesador que emplee 5 ciclos de reloj en ejecutar cualquier instrucción, pero en un caso no segmentado, y en otro caso segmentado en 5 etapas de 1 ciclo cada una:

\begin{figure}[htpb]
	\centering
		\includegraphics[width=0.60\textwidth]{Imagenes/Procesador/SecuencialVSSegmentado.eps}
	\caption{Ejecución secuencial comparada con ejecución segmentada}
	\label{fig:SecuencialVSSegmentada}
\end{figure}

Como podemos ver en la figura \ref{fig:SecuencialVSSegmentada}, el procesador no segmentado tarda 15 ciclos en ejecutar las 3 instrucciones y aplicando la formula anterior se obtiene que el valor de CPI es 5. Al ejecutar el mismo programa en el procesador segmentado, este tarda 5 ciclos en ocupar las 5 etapas del procesador. A partir de ese momento con cada ciclo de reloj se completa una instrucción, completándose la ejecución del programa en 7 ciclos de reloj. El nuevo valor de CPI es de 2,33. Así pues, la segmentación ha reducido el número de ciclos por instrucción de este programa a menos de la mitad.

%-----------------------------------------------------------------
\subsubsection{Inconvenientes de la segmentación}
%-----------------------------------------------------------------
\label{procesador:segmentacion:riesgos}

Un programa es un conjunto de instrucciones que ejecutadas en orden realizan una tarea específica. Al permitir ejecutar una instrucción sin terminar las anteriores pueden aparecer conflictos, denominados "`riesgos de segmentación"' y pueden ser de los siguientes tipos: \cite{Hennessy1993} % Arquitectura de Computadores: Un enfoque cuantitativo

\begin{enumerate}
  \item \textit{Riesgos estructurales}. Surgen cuando 2 o más instrucciones necesitan acceder a los mismos recursos.
	
	\item \textit{Riesgos de datos}. Surgen cuando la ejecución de una instrucción depende del resultado de una instrucción anterior, y este todavía no se ha escrito en el registro correspondiente. A su vez pueden ser:
	
	  \begin{itemize}
		  \item \textsl{Lectura después de escritura (RAW)}. Una instrucción intenta leer un dato antes de que se escriba en el registro.
			
			\item \textsl{Escritura después de lectura (WAR)}. La \textit{instrucción i+1} escribe el resultado en el registro antes de que la \textit{instrucción i} haya leído el dato del mismo registro. Esto solo ocurre con instrucciones que realicen una escritura anticipada como por ejemplo, las instrucciones de auto-incremento de direccionamiento.
			
			\item \textsl{Escritura después de escritura (WAW)}. Ocurre cuando las escrituras se realizan en orden incorrecto. Por ejemplo, cuando en un mismo registro, la \textit{instrucción i+1} escribe su resultado antes de que lo haga la \textit{instrucción i}.
			
			\item \textsl{Lectura después de lectura (RAR)}. Realmente no es un riesgo como tal, ya que no se modifica ningún dato.
	  \end{itemize}
		
	\item \textit{Riesgos de control}. Surgen a consecuencia de las instrucciones que afectan al registro del contador de programa (PC). 
\end{enumerate}


%-----------------------------------------------------------------
\section{ARM}
%-----------------------------------------------------------------
\label{procesador:arm}

La arquitectura ARM fue originalmente desarrollada por Acorn Computer Limited, entre los años 1983 y 1985.

Actualmente la arquitectura ARM es el conjunto de instrucciones más extensamente utilizado en unidades producidas. Esto se debe a su amplio uso en los sectores de telefonía móvil, sistemas de automoción, computadoras industriales y otros dispositivos. 

Lo que hace que esta arquitectura sea tan popular es la simpleza de sus núcleos, utilizan un número relativamente pequeño de transistores, permitiendo añadir funcionalidades específicas en otras partes del mismo chip \cite{Bustillos2012}. Por ejemplo, uno de los procesadores de ultima generación de la empresa Qualcomm, el "`Qualcomm Snapdragon 810"' esta compuesto por una CPU con 8 núcleos ARM, una unidad de procesamiento gráfico, controladores de pantalla, conectividad y cámara entre otros, todo ello en un único chip \cite{Mobile}. Figura \ref{fig:snapdragon-processors-810}.

\begin{figure}
	\centering
		\includegraphics[width=0.50\textwidth]{Imagenes/ARM/snapdragon-processors-810.png}
	\caption{Procesador Qualcomm Snapdragon 810}
	\label{fig:snapdragon-processors-810}
\end{figure}

Además de requerir poco espacio, los dispositivos ARM están diseñados con el objetivo de minimizar el consumo de energía, haciéndolo apropiado para sistemas móviles empotrados\footnote{Sistema de computación diseñado para realizar una o pocas funciones dedicadas.} que dependen de una batería. 

Por último, la arquitectura ARM es altamente modular, es decir, sus componentes como pueden ser la memoria caché o los controladores, se construyen como módulos independientes y opcionales..

Todo ello no impide que la arquitectura ARM resulte muy eficiente y proporcione un alto rendimiento.



%-----------------------------------------------------------------
\subsection{Arquitectura ARM}
%-----------------------------------------------------------------
\label{procesador:arm:arquitectura}

La arquitectura ARM \cite{Limited2007b} deriva de la arquitectura RISC con las características propias de esta:

\begin{itemize}
  \item Banco de registros uniforme.
	\item Instrucciones de tamaño fijo.
	\item Las instrucciones de procesamiento operan sobre los datos almacenados en los registros.
	\item Modos de direccionamiento simples.
\end{itemize}

La arquitectura ARM añade algunas características adicionales para proporcionar un equilibrio entre el rendimiento, el tamaño del código, el consumo y el silicio requerido, estas son:

\begin{itemize}
  \item Actualización de flags en la mayoría de instrucciones.
	\item Ejecución condicional de instrucciones.
	\item Auto-incremento y auto-decremento para el direccionamiento.
	\item Instrucciones de carga y almacenamiento múltiple.
\end{itemize}

La arquitectura ARM contiene un banco de registros con 31 registros de propósito general. De estos sólo son visibles 16, a los cuales puede acceder cualquier instrucción. Los otros registros se utilizan para acelerar el procesado. Tres de los 31 registros tienen un uso especial y son el "`puntero de pila (SP)"', el "`registro de enlace (LR)"' y el "`contador de programa (PC)"'.

%-----------------------------------------------------------------
\subsection{Repertorio de instrucciones ARM}
%-----------------------------------------------------------------
\label{procesador:arm:instrucciones}

El repertorio de instrucciones se divide en seis categorías:

\begin{itemize}

  \item \textbf{Salto}
	
	Además de permitir que las instrucciones aritmético-lógicas alteren el flujo de control, almacenando sus resultados en el registro PC, se incluye una instrucción estándar capaz de aplicar un salto de hasta 32MB hacia delante o hacia atrás.
	
  Otra instrucción de salto permite almacenar el valor del contador de programa en un registro para poder volver al mismo punto al finalizar el desvío. Esto es útil cuando se quiere llamar a una subrutina.
	
	También es posible lanzar instrucciones de salto que realizan un cambio de juego de instrucciones, en caso de necesitar lanzar subrutinas en alguno de los otros juegos de instrucciones compatibles con la arquitectura, tal es el caso de Thumb o Jazelle.
	
  \item \textbf{Procesamiento de datos}
	
	El procesamiento de datos se realiza mediante instrucciones aritmético-lógicas, operaciones de comparación, instrucciones sobre múltiples datos, instrucciones de multiplicación y operaciones diversas.
	
	Las instrucciones aritmético-lógicas, como su nombre describe, ejecutan operaciones aritméticas o lógicas sobre dos operandos. El primer operando siempre será un registro, mientras que el segundo puede ser un inmediato, o un segundo registro. El resultado se almacena en un registro.
	
	Como se ha comentado anteriormente, las operaciones de comparación aplican una operación aritmético-lógica. Sin embargo no escriben el resultado en un registro, actualizan los flags de condición.
	
  \item \textbf{Transferencia de registros de estado}
	
	Estas instrucciones son capaces de transferir contenidos entre los registros especiales CPSR y SPSR, y los registros de propósito general. 
	
	Al escribir en el registro CPSR se consigue establecer los valores de los bits de condición, habilitar o deshabilitar interrupciones, cambiar el estado y el modo del procesador, y cambiar el modo de acceso a memoria entre "`little endian"' o "`big endian"'.
	
  \item \textbf{Carga y almacenamiento}
	
	Las instrucciones de carga y almacenamiento permiten transmitir datos entre los registros de propósito general y la memoria externa.
	
	Se pueden cargar o almacenar los registros de forma individual, un solo dato por instrucción, o de forma colectiva, un bloque de datos con una sola instrucción.
	
  \item \textbf{Co-procesador}
	
	Las instrucciones de co-procesador comunican el procesador principal con un co-procesador auxiliar para transmitir instrucciones o datos.
	
	Existen tres clases de este tipo de instrucciones: Procesado de datos, comienza el trabajo específico del co-procesador. Transferencia de instrucciones, envía o recibe datos del procesador a la memoria. Transferencia de registro, envía o recibe datos entre los registros del microprocesador y el co-procesador.
	
  \item \textbf{Excepciones}
	
	Las instrucciones de excepción generan interrupciones en el programa. Las instrucciones "`Interrupción software"' normalmente se utilizan para realizar peticiones al sistema operativo. Mientras que las instrucciones "`Punto de interrupción software"' generan excepciones abortando la ejecución del programa.
	
\end{itemize}

Los procesadores ARM son capaces de procesar instrucciones de tres repertorios diferentes. El repertorio ARM \cite{ARM-InstructionSet}, el set Thumb/ Thumb-2 \cite{R.B.J.BrinkgreveW.M.Swolfs2011} y las instrucciones Jazelle \cite{ARM-InstructionSet}.

%-----------------------------------------------------------------
\subsection{Segmentación ARM}
%-----------------------------------------------------------------
\label{procesador:arm:segmentacion}

La evolución de los ARM ha significado un aumento en la cantidad de etapas en las que se divide el procesador. La familia "`ARM7TDMI"' consta de 3 etapas, mientras que la familia "`ARM9TDMI"' se divide en 5 etapas, y la familia "`Cortex"' se compone de 13 etapas.

La arquitectura del "`ARM7TDMI"', como se ha comentado, está segmentada en 3 etapas para aumentar la velocidad de flujo de entrada de las instrucciones en el procesador. Permite realizar varias operaciones al mismo tiempo y operar de forma continua. \cite{Limited2000}

Las tres etapas en las que se divide la segmentación del "`ARM7TDMI"' son: (Figura \ref{fig:ARM-Pipeline})

\begin{enumerate}
  \item \textbf{Búsqueda de instrucción}
	
  Se accede a la memoria para extraer la instrucción.	
  
	\item \textbf{Decodificación}
	
	Los registros utilizados son extraídos de la instrucción.
	
  \item \textbf{Ejecución}

  Los valores de los registros se extraen del banco de registros, se realizan las operaciones, y se almacenan los resultados en el banco de registros.

\end{enumerate}

\begin{figure}
	\centering
		\includegraphics[width=0.80\textwidth]{Imagenes/ARM/ARM-Pipeline.eps}
	\caption{Segmentación ARM}
	\label{fig:ARM-Pipeline}
\end{figure}

Mientras se ejecuta una instrucción, la siguiente es decodificada y una tercera es traída de memoria. 

%-----------------------------------------------------------------
\subsection{Memoria ARM}
%-----------------------------------------------------------------
\label{procesador:arm:memoria}

Se utiliza una arquitectura Von-Neumann con un único bus de 32 bits para acceder tanto a las instrucciones como a los datos.

El único tipo de instrucciones con acceso a memoria son las instrucciones de carga y almacenamiento. Puede transmitir datos de 8, 16 o 32 bits, alineados cada 1, 2 y 4 bytes respectivamente. \cite{Limited2000}

%%-----------------------------------------------------------------
\section{Field-Programmable Gate Arrays (FPGA)}
%%-----------------------------------------------------------------
\label{procesador:fpga}

Las FPGAs, del inglés Field-Programmable Gate Arrays, consisten en bloques lógicos con conexiones programables para realizar diferentes diseños \cite{Rose}. Figura \ref{fig:ArquitecturaFPGA}.

Los bloques pueden ser tan simples como un transistor o tan complejos como un microprocesador. Las FPGAs comerciales suelen tener bloques basados en:

\begin{itemize}

	\item Parejas de transistores.
	
	\item Puertas lógicas simples.
	
	\item Multiplexores.
	
	\item Look-up tables (LUT).
	
	\item Estructuras de puertas AND-OR.
	
\end{itemize}

\begin{figure}
	\centering
		\includegraphics[width=0.75\textwidth]{Imagenes/FPGA/ArquitecturaFPGA.eps}
	\caption{Arquitectura de una FPGA \cite{Brown1996}.}
	\label{fig:ArquitecturaFPGA}
\end{figure}

Debido a su naturaleza re-configurable, las FPGAs conllevan un mayor coste en área, retardos y consumo de energía: requieren un área 20 veces mayor, consume 10 veces más energía y trabaja 3 veces más lenta \cite {Kuon2007}. Estas desventajas son minimizadas por la ventaja de permitir que el sistema funcione de forma casi inmediata.

Las ventajas de este tipo de dispositivos residen en su gran versatilidad, flexibilidad, su alta frecuencia de trabajo, su capacidad de procesamiento en paralelo, y a su bajo precio en comparación con los "`Circuitos Integrados para Aplicaciones Específicas (ASICs)"'\footnote{Circuitos integrados hechos a la medida para un uso particular.}.

\begin{figure}
	\centering
		\includegraphics[width=0.65\textwidth]{Imagenes/FPGA/UsoFPGA.png}
	\caption{Distribución del uso de FPGAs en el año 2008.}
	\label{fig:UsoFPGA}
\end{figure}

Es por ello que las FPGAs se utilizan en todo tipo de sectores desde el procesamiento de datos y las comunicaciones hasta el sector de la automoción, el sector militar y el sector aeroespacial. Ha sido el sector de comunicaciones, como vemos en la figura \ref{fig:UsoFPGA}, el que más uso hacía de esta tecnología en 2008.

%%-----------------------------------------------------------------
\subsection{Nexys 4}
%%-----------------------------------------------------------------
\label{procesador:fpga:nexys}

Para el desarrollo de este proyecto se ha utilizado la placa de prototipado "`Nexys 4"' \cite{Flash2013}, figura \ref{fig:Nexys4-top-2000}. Ésta placa se basa en la FPGA Artix-7 de Xilinx, proporcionando a la misma acceso a memorias externas, puertos de entrada/salida (USB, ethernet, etc), y una serie de sensores y periféricos integrados (acelerómetro, sensor de temperatura, micrófono, etc).  

\begin{figure}
	\centering
		\includegraphics[width=0.9\textwidth]{Imagenes/FPGA/Nexys4-top-2000.eps}
	\caption{Placa de prototipado Nexys 4}
	\label{fig:Nexys4-top-2000}
\end{figure}

La FPGA Artix-7 (XC7A100T-1CSG324C) \cite{XilinxArtix}, está optimizada para la lógica de altas prestaciones y ofrece más recursos y mejor rendimiento que sus predecesoras. Esta FPGA consta de:

\begin{itemize}
  \item 15,850 bloques lógicas (cada porción contiene 6 LUTs y 8 biestables).
	\item 4,860 Kb de bloques RAM. 
  \item 6 lineas de reloj.
  \item Velocidad interna de reloj superior a 450MHz.
	\item 240 bloques DSP.
	\item Conversor analógico-digital integrado (XADC).
\end{itemize}

Algunos perifericos incluidos en la placa son: 16 interruptores, 16 LEDs, puerto USB-UART, lector de tarjeta microSD, salida de audio, salida VGA, acelerómetro, sensor de temperatura, 16MB de memoria CellularRAM y puerto ethernet 10/100.









